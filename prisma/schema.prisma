generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum VerifiedStatus {
  none
  identity
  manual
}

enum PostVisibility {
  public
  verifiedOnly
  premiumOnly
}

enum FollowVisibility {
  all
  verified
  premium
  none
}

// Start minimal. Add real domain models as you solidify your product.
model Example {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  name      String
}

model User {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  phone     String    @unique
  // Username stored as entered (case preserved). Uniqueness is enforced case-insensitively
  // via a functional unique index on LOWER(username) in a migration.
  username String?
  // Public profile fields.
  name String?
  bio  String?
  // True when the user has explicitly chosen a username.
  usernameIsSet Boolean @default(false)
  // Minimal admin flag (will be replaced by real roles later).
  siteAdmin Boolean @default(false)
  // Premium flag (paid product access; used for visibility gating).
  premium Boolean @default(false)
  // Verified badge (more roles/permissions later).
  verifiedStatus VerifiedStatus @default(none)
  verifiedAt DateTime?
  unverifiedAt DateTime?
  // Follow list privacy (controls counts + follower/following lists).
  followVisibility FollowVisibility @default(all)
  // Public media (stored in object storage; API stores keys only).
  avatarKey String?
  avatarUpdatedAt DateTime?
  bannerKey String?
  bannerUpdatedAt DateTime?
  sessions  Session[]
  posts     Post[]
  // Social graph (self-referential via Follow).
  // `following`: users this user follows (outgoing edges)
  // `followers`: users who follow this user (incoming edges)
  following Follow[] @relation("Follow_follower")
  followers Follow[] @relation("Follow_following")

  @@index([phone])
}

model Follow {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  followerId  String
  followingId String

  follower  User @relation("Follow_follower", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("Follow_following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId, createdAt])
  @@index([followingId, createdAt])
}

model Post {
  id         String         @id @default(cuid())
  createdAt  DateTime       @default(now())
  body       String
  visibility PostVisibility @default(public)

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([createdAt])
}

model PhoneOtp {
  id            String    @id @default(cuid())
  createdAt     DateTime  @default(now())
  phone         String
  codeHash      String
  expiresAt     DateTime
  consumedAt    DateTime?
  resendAfterAt DateTime?

  @@index([phone, createdAt])
  @@index([expiresAt])
}

model Session {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  expiresAt DateTime
  revokedAt DateTime?
  tokenHash String    @unique

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

